{% extends "cynr_app/modalFormItemPadreHijoBase.html" %}

{% block mapa_geom %}
<div class="modal-body">
  <div id="mapid" style="height: 400px;"></div>
  <script>
    // Layers de base
    var streets = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
      maxZoom: 18,
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                   '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                   'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
      id: 'mapbox/streets-v11',
      tileSize: 512,
      zoomOffset: -1
      })
    var satellite = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
    maxZoom: 18,
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                  '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                  'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
    id: 'mapbox/satellite-streets-v11',
    tileSize: 512,
    zoomOffset: -1
    })
    var baseMaps = {
        "Satélite": satellite,
        "Mapa": streets
                    };  

      var map = L.map('mapid',{drawControl: true,
                              center: [-31.384057, -58.019295],
                              zoom: 5,
                              layers:[streets,satellite],
                            });
      L.control.layers(baseMaps).addTo(map);
      L.control.scale({metric:true,imperial:false}).addTo(map);
      {% if obj.geom.json %}
      // control para cambiar la capa base
      var geometria = L.layerGroup().addTo(map);
      var geometria_actual =L.geoJSON({{ obj.geom.json|safe }});
      //geometria_actual.options.pmIgnore = false;
      geometria.addLayer(geometria_actual);
      {% endif %} 
    // add leaflet-geoman controls with some options to the map
    map.pm.addControls({
        position: 'topleft',
        drawCircle: false,
        drawRectangle:false,
        drawCircleMarker:false,
                      });
                      
    $('#crearItemModal').on('shown.bs.modal', function(){
      map.invalidateSize();
    });
    function cargarGeo() {
      wkt_collection = "GEOMETRYCOLLECTION(";
      //var geom = map.pm.getGeomanDrawLayers();
      var geom = map.pm.getGeomanLayers();
      geom.forEach(function(item){
          switch (item["pm"]["_shape"]) {
            case "Marker":
              wkt_collection = wkt_collection + "POINT("+item["_latlng"]["lng"]+" "+item["_latlng"]["lat"]+"),"; 
              break;
            case "Line":
              var line_points ="LINESTRING(";
              item["_latlngs"].forEach(coord => line_points = line_points + coord["lng"] + " " + coord["lat"]+ ",")
              line_points = line_points.substring(0,line_points.length-1); // quitamos la ultima coma que no va y genera un error en el GEOSGeometry() de django
              line_points = line_points + "),";
              wkt_collection = wkt_collection + line_points;       
              break;
            case "Polygon":
              var first_point = item["_latlngs"][0][0].lng + " " + item["_latlngs"][0][0].lat // primer punto del poligono para repetir al final
              var polig_points = "POLYGON(("
              item["_latlngs"][0].forEach(coord => polig_points = polig_points + coord["lng"] + " " + coord["lat"]+ ",")
              polig_points = polig_points + first_point ; // repetimos el primer punto
              polig_points = polig_points + ")),";
              wkt_collection = wkt_collection + polig_points;       
              break;
          }
      })
      wkt_collection = wkt_collection.substring(0,wkt_collection.length-1); // quitamos la ultima coma que no va y genera un error en el GEOSGeometry() de django
      wkt_collection = wkt_collection + ")";
      return wkt_collection;
    }
    function getGeo() {
      document.getElementById("id_geom").value = cargarGeo();
    }        
  </script>
{% endblock mapa_geom %}

{% block funcion_edit %} 
onsubmit="getGeo()"
{% endblock %}

{% block funcion_create %} 
onsubmit="getGeo()"
{% endblock %}

{% block campo_geom %}
<div class="form-group">
  <div class="col-md-12">
    <input type="hidden" name="geom" maxlength="200" class="form-control" required="" id="id_geom">
  </div>
</div>
{% endblock campo_geom %}

{% block enctype_edit %} enctype="multipart/form-data" {% endblock enctype_edit %}
{% block enctype_create %} enctype="multipart/form-data" {% endblock enctype_create %}